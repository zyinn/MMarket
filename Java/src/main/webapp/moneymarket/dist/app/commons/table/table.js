!function(e){"use strict";function t(t,i,r,o,n,a,s,c,f,u,l){function d(t){if(t&&t.quoteDetails){var i=e.copy(q);if(!(!t.quoteDetails instanceof Array)){if(0===t.quoteDetails.length)return t.quoteDetails=i;t.quoteDetails.forEach(function(e){i.forEach(function(t){e.quoteTimePeriod&&t.quoteTimePeriod&&e.quoteTimePeriod===t.quoteTimePeriod&&(t.multipeRecords=e.multipeRecords,null===e.priceDisplayString?t.priceDisplayString="-":t.priceDisplayString=e.priceDisplayString,t.priceDetails=e.priceDetails)})}),t.quoteDetails=i}}}function p(){var e;"inner"===n?e="MMFI.Search="+g.searchKeyword:"offline"===n&&(e="MMCD.Search="+g.searchKeyword),console.log("埋点数据："+e),u.sendBurying(e)}function y(e){"qb"==e?g.qbOfferList=[]:"market"==e&&(g.marketOfferList=[])}function m(t){if(r.filter.direction!==t.direction){var i=g[g.state+"OfferList"];return void(i&&t.quoteId&&(g[g.state+"OfferList"]=i.findWhere(function(e){return e.quoteId!==t.quoteId})))}if("inner"!==n||!r.filter.quote_type||r.filter.quote_type.indexOf(t.quoteType)!==-1){a.trustType;"offline"===n&&("IBD"!==t.quoteType||r.filter.trust_type===!0&&t.custodianQualification===!1)||r.filter.province.length&&r.filter.province.indexOf(t.province)===-1||null===t.province&&r.filter.province instanceof Array&&0!==r.filter.province.length||!t.bankNature||r.filter.bankNatures.length&&r.filter.bankNatures.indexOf(t.bankNature)===-1||t.fundSizeEnum&&0!==r.filter.fundSizes.length&&r.filter.fundSizes.indexOf(t.fundSizeEnum)===-1||null===t.fundSizeEnum&&r.filter.fundSizes instanceof Array&&0!==r.filter.fundSizes.length||(t.tags=e.copy(r.filter.tagNames).findWhere(function(e){return t.memo.indexOf(e)!==-1}),t.memo&&0!==r.filter.tagNames.length&&0===t.tags.length||r.isSelf&&c.getUserId()!==t.quoteOperatorId&&c.getUserId()!=t.quoteUserId||b(t)&&("qb"===g.state&&"PRIME_QB"===t.quoteSource?O(t):"market"===g.state&&O(t)))}}var g=this;g.financingType=n,"inner"===n?r.setFinancingType("inner"):"offline"===n&&r.setFinancingType("offline"),r.initOptions(),g.state="market",g.isSelf=0;var h=function(){g.qbPage=1,g.marketPage=1};h(),r.isInit=!0;var q=[{multipeRecords:!1,priceDisplayString:"-",quoteTimePeriod:"T1D",priceDetails:[]},{multipeRecords:!1,priceDisplayString:"-",quoteTimePeriod:"T7D",priceDetails:[]},{multipeRecords:!1,priceDisplayString:"-",quoteTimePeriod:"T14D",priceDetails:[]},{multipeRecords:!1,priceDisplayString:"-",quoteTimePeriod:"T1M",priceDetails:[]},{multipeRecords:!1,priceDisplayString:"-",quoteTimePeriod:"T2M",priceDetails:[]},{multipeRecords:!1,priceDisplayString:"-",quoteTimePeriod:"T3M",priceDetails:[]},{multipeRecords:!1,priceDisplayString:"-",quoteTimePeriod:"T6M",priceDetails:[]},{multipeRecords:!1,priceDisplayString:"-",quoteTimePeriod:"T9M",priceDetails:[]},{multipeRecords:!1,priceDisplayString:"-",quoteTimePeriod:"T1Y",priceDetails:[]}];g.initData=function(e){e||(e=g.state),h(),y(g.state),g.isLoading=!0;var t=function(){g.state="qb",r.getQbOfferList(1).success(function(e){e.result.forEach(function(e){d(e)}),g.qbOfferList=e.result,g.isLoading=!1})},i=function(){g.state="market",r.getMarketOfferList(1).success(function(e){e.result.forEach(function(e){d(e)}),g.marketOfferList=e.result,g.isLoading=!1})};switch(e){case"qb":t();break;case"market":i()}},g.initData(g.state),g.switchOfferType=function(e){e!=g.state&&(r.filter.orderByPeriod=null,r.filter.orderSeq="",g.initData(e))};var D={"机构":"INSTITUTE","QB用户":"CONTACT","QQ用户":"CONTACT","备注":"MEMO"};g.clickSearchInput=function(){g.openDropdown=!g.openDropdown},g.clickSearchClose=function(){g.initFilter("mySearch"),g.searchKeyword="",S()},g.memoType="备注";var T=_.debounce(function(){g.searchKeyword&&(r.searchKeyword(g.searchKeyword).success(function(e){var t=e.result;g.orgList=t[0].list,g.orgType=t[0].type,g.qbUserList=t[1].list,g.qbUserType=t[1].type,g.qqUserList=t[2].list,g.qqUserType=t[2].type,g.memoWord=g.searchKeyword,g.openDropdown=!0}),t.$apply())},300);g.searchMemo=function(){g.initFilter("mySearch"),g.openDropdown=!1,r.searchType=D[g.memoType],r.keyword=g.searchKeyword,g.initData(g.state)};var w=function(e,t){g.initFilter("mySearch"),g.openDropdown=!1,r.searchType=D[e],r.keyword=t,g.initData(g.state)},S=function(){r.searchKeyword(g.searchKeyword).success(function(e){for(var t,i,r=e.result,o=!1,n=0;n<=2;n++)if(r[n].list.length>0){t=r[n].type,i=r[n].list[0].id,o=!0,g.searchKeyword=r[n].list[0].name;break}o||(i=g.searchKeyword,t=g.memoType),w(t,i)})};g.searchKeyup=function(e){return e.ctrlKey===!0&&e.altKey&&120===e.keyCode?void c.logout():void(13==e.keyCode?(S(),p()):g.searchKeyword&&g.searchKeyword.length>1?T():(g.openDropdown=!1,void 0!==g.searchKeyword&&g.searchKeyword.length<=0&&8===e.keyCode&&g.searchMemo()))},g.selectSearch=function(e,t,i){g.initFilter("mySearch"),$(e.target).parents(".dropdown-menu").prev().focus(),g.searchKeyword=t.name,r.keyword=t.id,r.searchType=D[i],g.initData(g.state)},g.initFilter=function(e){t.$emit("initFilter",e),"mySearch"===e?g.isSelf=0:"myPrice"===e&&(r.searchType="",r.keyword="",g.searchKeyword="")},g.loadQbData=function(e){g.qbPage++,r.getQbOfferList(g.qbPage).success(function(t){return t.result.length?(t.result.forEach(function(e){d(e)}),g.qbOfferList=g.qbOfferList.concat(t.result),void("function"==typeof e&&e())):void console.log("没有数据了")})},g.loadMarketData=function(e){g.marketPage++,r.getMarketOfferList(g.marketPage).success(function(t){return t.result.length?(t.result.forEach(function(e){d(e)}),g.marketOfferList=g.marketOfferList.concat(t.result),void("function"==typeof e&&e())):void console.log("没有数据了")})},g.manageOffer=function(){({inner:"OUT",offline:"IN"})[n];o.openModal(function(e){})},g.marketAnalysis=function(){return void 0===g.openWindow||g.openWindow.closed?void(g.openWindow=f.open("market-analysis.html?tab=false","market-analysis","width=1000,height=700,left=300,top=100,titlebar=no,toolbar=no,menubar=no,scrollbars=auto,resizable=no,location=no,status=no")):void g.openWindow.focus()};var k=l.get("firstMarket");void 0===k&&(g.marketAnalysis(),l.put("firstMarket","false",{expires:new Date("January 6, 2119")})),g.changeFilter=function(){g.initFilter("myPrice"),r.isSelf=g.isSelf,g.isSelf&&(r.searchType="CONTACT",r.keyword=c.getUserId()),g.initData(g.state)},t.$on("refreshList",function(e,t){g.initData(g.state)});var v=r.connectWebSocket();v.onopen=function(){console.log("open")},v.onmessage=function(e){if(e.data){if("ping"===e.data)return void console.log("Received ping for keeping wsandlocalmessage connection.");var r=JSON.parse(e.data);if(console.log(r),"QUOTES_CHANGE"===r.messageType){var o=r.message;o.isNew=!0,m(o),s(function(){o.isNew=!1},500)}}i.safeApply(t)},v.onclose=function(e){console.log("close")};var b=function(e){if(r.keyword)switch(r.searchType){case"INSTITUTE":if(e.institutionId!==r.keyword)return!1;break;case"CONTACT":if(r.isSelf){if(e.quoteUserId!==r.keyword&&e.quoteOperatorId!==r.keyword)return!1}else if(e.quoteUserId!==r.keyword)return!1;break;case"MEMO":if(e.memo.indexOf(r.keyword)===-1)return!1;break;default:return!1}return!0},O=function(i){var o=g[g.state+"OfferList"];if(!(!o||!o instanceof Array||!i.quoteDetails instanceof Array)&&i.quoteId&&i.expiredDate){var n=i.quoteId,a=Number(i.expiredDate),s=o.length,c=e.copy(q),f=o.indexOfItem(function(e){return!!e.quoteId&&e.quoteId===n});if(f>=0)a<(new Date).getTime()?(o=o.findWhere(function(e){if(e.quoteId)return e.quoteId!==n}),g[g.state+"OfferList"]=o):(null===r.filter.orderByPeriod&&(i.quoteDetails.forEach(function(e){c.forEach(function(t){t.quoteTimePeriod&&e.quoteTimePeriod&&e.quoteTimePeriod===t.quoteTimePeriod&&(t.priceDisplayString=e.priceDisplayString,t.multipeRecords=e.multipeRecords,t.priceDetails=e.priceDetails)})}),i.quoteDetails=c,o=o.findWhere(function(e){if(e.quoteId)return e.quoteId!==n}),o.unshift(i),o.length>s&&o.length>200&&o.splice(o.length-1,1),g[g.state+"OfferList"]=o),t.$broadcast("hasNewData"));else{if(a<(new Date).getTime())return;null===r.filter.orderByPeriod&&(i.quoteDetails.forEach(function(e){c.forEach(function(t){t.quoteTimePeriod&&e.quoteTimePeriod&&e.quoteTimePeriod===t.quoteTimePeriod&&(t.priceDisplayString=e.priceDisplayString,t.multipeRecords=e.multipeRecords,t.priceDetails=e.priceDetails)})}),i.quoteDetails=c,o=o.findWhere(function(e){if(e.quoteId)return e.quoteId!==n}),o.unshift(i),o.length>s&&o.length>200&&o.splice(o.length-1,1),g[g.state+"OfferList"]=o),t.$broadcast("hasNewData")}}};t.$on("$destroy",function(){v.close()}),t.$on("toTableInstitution",function(e,i){g.searchKeyword=i.name,r.keyword=i.id,r.searchType=D["机构"],g.isSelf=!1,r.isSelf=!1,t.$emit("filterChanged")})}e.module("moneyMarketApp").controller("tableController",t),t.$inject=["$scope","commonService","tableService","offerService","financingType","enumConfig","$timeout","userinfoService","$window","qbService","$cookies"]}(window.angular);