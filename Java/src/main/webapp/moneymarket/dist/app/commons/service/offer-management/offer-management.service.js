!function(e){"use strict";e.module("services").service("offerService",["$http","$uibModal","appConfig","enumConfig",function(t,a,o,n){function i(e,t){var a={institutionId:t.institutionId,displayName:t.institutionName,displayOrder:-1};if(e&&e.result&&e.result.length>0){var o=e.result[0].alliance.findItem(function(e){return e.institutionId===t.institutionId});return o?o:a}return a}function r(e,t){return!e&&!t||!(!e&&t||e&&!t)&&(e.id?+e.daysHighValue===+t.daysLowValue:+e.daysLowValue===+t.daysLowValue)}function l(e){e.daysLowValue%360===0?e.header=e.daysLowValue/360+"年":e.daysLowValue%30===0?e.header=e.daysLowValue/30+"个月":e.header=e.daysLowValue+"天"}var d={quoteMethods:[{name:"普通报价","enum":"SEF"},{name:"联盟报价","enum":"ALC"},{name:"代报价","enum":"BRK"}],quoteMethodMap:{SEF:{templateUrl:"app/commons/service/offer-management/offer-management.html",controllerSrc:"app/commons/service/offer-management/offer-management.controller.js",controllerName:"offerManageController"},ALC:{templateUrl:"app/commons/service/offer-management/alliance-offer-management.html",controllerSrc:"app/commons/service/offer-management/alliance-offer-management.controller.js",controllerName:"allianceOfferManageController"},BRK:{templateUrl:"app/commons/service/offer-management/alliance-offer-management.html",controllerSrc:"app/commons/service/offer-management/alliance-offer-management.controller.js",controllerName:"allianceOfferManageController"}},boardDirection:[{displayName:"出",value:"OUT"},{displayName:"收",value:"IN"}],periodDefine:[{id:1,type:"T1D",header:"1天",daysLowValue:0,daysHighValue:1},{id:2,type:"T7D",header:"7天",daysLowValue:2,daysHighValue:7},{id:3,type:"T14D",header:"14天",daysLowValue:8,daysHighValue:14},{id:4,type:"T1M",header:"1个月",daysLowValue:15,daysHighValue:30},{id:5,type:"T2M",header:"2个月",daysLowValue:31,daysHighValue:60},{id:6,type:"T3M",header:"3个月",daysLowValue:61,daysHighValue:90},{id:7,type:"T6M",header:"6个月",daysLowValue:91,daysHighValue:180},{id:8,type:"T9M",header:"9个月",daysLowValue:181,daysHighValue:270},{id:9,type:"T1Y",header:"1年",daysLowValue:271,daysHighValue:360}],activeDefine:{"true":!0,"false":!1}},u=!1,s=[function(){return t.post(o.get_alliance).then(function(e){return e&&e.data&&e.data.result&&e.data.result[0]&&e.data.result[0].alliance&&e.data.result[0].alliance.forEach(function(e,t){e.displayOrder=t}),e.data},function(e){return e})}];this.dataDefine=d,this.isSameSpPeriod=r,this.setSpPeriodHeader=l,this.boardFactory=function(t,a,o){var n={boardDir:d.boardDirection.findItem(function(e){return e.value===t.direction}),institutionInfo:i(o,t),remark:t.memo,periodList:a.map(function(a){if(!t.quoteDetailsDtos)return e.copy(a);var o=t.quoteDetailsDtos.findItem(function(e){return e.limitType===a.type});return o?{type:o.limitType,period:o.price,id:a.id}:e.copy(a)}),seqNo:t.sequence,id:t.id,active:t.quoteDetailsDtos[0].active};return n.institutionInfo?(n.institutionInfo.displayOrder===-1&&(n.displayOrder=-1),n.displayOrder=1e3*(1e3+n.institutionInfo.displayOrder)+t.sequence):n.displayOrder=t.sequence,t.quoteDetailsDtos.findWhere(function(e){return!e.limitType}).forEach(function(t,o){var i={isRange:t.dayHigh!==t.dayLow,daysLowValue:t.dayLow,daysHighValue:t.dayHigh,period:t.price},d=a.indexOfItem(function(e){return r(e,i)});if(d&&1!==d&&2!==d)n.periodList.length<a.length?n.periodList.splice(d,void 0,i):n.periodList[d]=i;else{var u=e.copy(i);l(u),delete u.period,a.findItem(function(e){return e.daysLowValue===u.daysLowValue&&e.daysHighValue===u.daysHighValue})||a.push(u),n.periodList.push(i)}}),n},this.openModal=function(e){if(!u){var o=d.quoteMethodMap.SEF;n&&n.quoteMethod&&n.quoteMethod[0]&&d.quoteMethodMap.hasOwnProperty(n.quoteMethod[0])&&(o=d.quoteMethodMap[n.quoteMethod[0]]);var i=a.open({animation:!1,templateUrl:o.templateUrl,size:"lg",backdrop:"static",controller:o.controllerName,bindToController:!0,controllerAs:"vm",resolve:{load:["$ocLazyLoad",function(e){return e.load([o.controllerSrc])}],quoteQuery:[function(){return u=!0,t.post("quote/get").then(function(e){return u=!1,e.data},function(e){u=!1})}],allianceQuery:s}});i.result.then(function(t){"function"==typeof e&&e(t)},function(e){})}},this.openReadOnlyModal=function(e,t,o){if(!u){var n="yyyy-MM-dd HH:mm:ss",i=a.open({animation:!1,templateUrl:"app/commons/service/offer-management/queryAllianceQuote.html",size:"lg",backdrop:"static",controller:"queryAllianceQuoteController",bindToController:!0,resolve:{load:["$ocLazyLoad",function(e){return e.load(["app/commons/service/offer-management/queryAllianceQuoteController.js"])}],boardQuery:["$http","appConfig",function(e,a){function o(e){e&&e.data&&e.data.MmQuoteWithContactDto.length&&(e.data.institutionName=e.data.MmQuoteWithContactDto[0].primeInstitutionName,e.data.lastUpdate=new Date,e.data.lastUpdate.setTime(t.last_update),e.data.lastUpdate=e.data.lastUpdate.format(n),e.data.contactsList.forEach(function(e){var t=[],a=[];e.mobile&&(t=e.mobile.replace(";",",").split(",")),e.telephone&&(a=e.telephone.replace(";",",").split(",")),e.contact=t.concat(a)}))}return u=!0,e.post(a.get_brother_alliance,{institutionId:t.institution_id}).then(function(e){return o(e),u=!1,e.data},function(e){return o(e),u=!1,e.data})}]}});i.result.then(function(t){"function"==typeof e&&e(t)},function(e){})}}}])}(angular);