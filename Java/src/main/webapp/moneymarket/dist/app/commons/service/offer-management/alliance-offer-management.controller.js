!function(e){"use strict";e.module("services").controller("allianceOfferManageController",["$scope","$uibModal","$uibModalInstance","$http","$timeout","commonService","bootbox","offerService","tabNavigatorService","appConfig","enumConfig","offerConfirm","quoteQuery","allianceQuery","tableService",function(t,i,n,o,a,r,s,d,u,c,l,f,p,v,m){function h(t,i){return e.copy({seqNo:void 0,type:t,methodType:q.quoteMethod,tags:e.copy(q.tags),institutionInfo:i,institutionContactsName:i.institutionContactsName,institutionContactsId:i.institutionContactsId,boardDir:d.dataDefine.boardDirection.findItem(function(e){return e.value===t.direction}),periodList:q.periodList.findWhere(function(e){return!q.isIBD||(e.id||!e.id&&"7天"!==e.header&&"14天"!==e.header)}),remark:"",active:d.dataDefine.activeDefine["true"]})}function y(e,t){return e.type&&t.type?e.id-t.id:e.type&&!t.type?-1:!e.type&&t.type?1:e.daysLowValue-t.daysLowValue}function L(){q.boardList&&q.boardList.findWhere(function(e){return 0!==e.active&&e.type.value===q.selectType.value}).forEach(function(e,t){e.periodList&&!(e.periodList.length<=0)&&e.periodList instanceof Array&&e.periodList.forEach(function(e,i){e.tabIndex=t*(q.periodList.length+2)+1+i})})}function g(t){t.forEach(function(t,i){var n=d.boardFactory(t,q.periodList,v);if("OUT"===n.boardDir.value?n.periodList.forEach(function(e){null===e.period&&(e.period="OFR")}):"IN"===n.boardDir.value&&n.periodList.forEach(function(e){null===e.period&&(e.period="BID")}),n.seqNo=t.sequence,t.quoteOperatorName&&t.quoteUserId?(n.institutionContactsName=t.quoteOperatorName,n.institutionContactsId=t.quoteUserId):(n.institutionContactsName="",n.institutionContactsId=""),t.tags){var o=e.copy(q.tags);o.forEach(function(e){t.tags.forEach(function(t){e.tagCode===t.tagCode&&(e.selected=!0)})}),n.tags=o,n.tagsNumber=n.tags.findWhere(function(e){return e.selected===!0}).length}else n.tags=e.copy(q.tags),n.tagsNumber=0;n.methodType=q.quoteMethod,n.type=C.typeListDefine.findItem(function(e){return e.value===t.quoteType}),n.type&&q.boardList.push(n)}),q.boardList.sort(function(e,t){return e.displayOrder-t.displayOrder}),q.periodList.sort(y),q.boardList.forEach(function(t,i){var n=e.copy(q.periodList);t.periodList.forEach(function(e){n.forEach(function(t){t.id&&e.id&&t.id===e.id?t.period=e.period:t.daysLowValue===e.daysLowValue&&t.isRange===e.isRange&&(t.period=e.period)})}),t.periodList=n,"IBD"!==t.type.value?t.periodList=t.periodList.findWhere(function(e){return!e.id||e.id&&"T7D"!==e.type&&"T14D"!==e.type}):t.periodList=t.periodList.findWhere(function(e){return e.id||!e.id&&"7天"!==e.header&&"14天"!==e.header})}),L()}function D(e){o.post(c.post_board,{offer_data:e}).then(function(t){t&&t.data&&0===t.data.return_code?n.close(e):console.log("sendBoardList error",t)},function(t){t&&t.data&&0===t.data.return_code?n.close(e):console.log("sendBoardList error",t)})}function I(e){var t=T?c.post_saveExcel:c.post_alliance_board;o.post(t,{offer_data:e}).then(function(t){t&&t.data&&0===t.data.return_code?n.close(e):(console.log("sendAllianceBoardList error",t),q.isLocked=!1)},function(t){t&&t.data&&0===t.data.return_code?n.close(e):(console.log("sendAllianceBoardList error",t),q.isLocked=!1)})}function b(){var e=h(q.selectType),t=0;q.boardList.forEach(function(e,i){delete e.isQuoted,e.seqNo>t&&(t=e.seqNo)}),e.seqNo=t+1,q.boardList.push(e),L()}function N(){if(l&&l.quoteMethod&&(l.quoteMethod[0]===C.quoteMethodDefine[1].value||l.quoteMethod[0]===C.quoteMethodDefine[2].value)){var e=i.open({animation:!1,templateUrl:"app/commons/service/offer-management/allianceAddQuote.html",size:"sm addQuoteModal",backdrop:"static",controller:"allianceAddQuoteController",bindToController:!0,resolve:{load:["$ocLazyLoad",function(e){return e.load([])}],getAlliance:[function(){return v}],addedBoard:[function(){return q.boardList.findWhere(function(e){return e&&0!==e.active}).map(function(e){return e.institutionInfo})}],getBrotherAlliance:[function(){}]}});return void e.result.then(function(e){if(e){var t=e.map(function(e){return h(q.selectType,e)}).sort(function(e,t){return e.institutionInfo.displayOrder-t.institutionInfo.displayOrder});t.forEach(function(e,t){var i=q.boardList.lastIndexOfItem(function(t){return t.institutionInfo.displayOrder===e.institutionInfo.displayOrder});i>=q.boardList.length-1||void 0===i?q.boardList.push(e):q.boardList.splice(i+1,0,e)});var i=0,n=void 0;q.boardList.forEach(function(e,t){delete e.isQuoted,e.institutionInfo&&e.institutionInfo.displayOrder!==-1&&(n?n===e.institutionInfo.institutionId?e.seqNo?i=e.seqNo:e.seqNo=++i:(e.seqNo?i=e.seqNo:(i=0,e.seqNo=++i),n=e.institutionInfo.institutionId):(e.seqNo?i=e.seqNo:e.seqNo=++i,n=e.institutionInfo.institutionId))}),L()}},function(e){})}q.boardList.push(h(q.selectType,item))}var C={quoteMethodDefine:[{displayName:"普通报价",value:"SEF"},{displayName:"联盟报价",value:"ALC"},{displayName:"代报价",value:"BRK"}],typeListDefine:[{displayName:"同存",value:"IBD",direction:"IN"},{displayName:"保本",value:"GTF",direction:"OUT"},{displayName:"非保本R2",value:"UR2",direction:"OUT"},{displayName:"非保本R3",value:"UR3",direction:"OUT"}],dto:{saveQuote:{id:"id",quoteType:"type.value",direction:"boardDir.value",methodType:"methodType.value",memo:"remark",institutionId:"institutionInfo.institutionId",sequence:"seqNo",tags:"tags",active:"active"},saveQuoteQuoteDetailsVO:{limitType:"type",price:"period"},saveQuoteSpQuoteDetailsVO:{dayHigh:"daysHighValue",dayLow:"daysLowValue",price:"period"}}},q=this;q.tags=e.copy(d.featureList),q.tags.shift(),q.tagsNumber=0,q.isLocked=!1;var T=!1;q.isIBD=!0,q.boardListFilter=function(e,t,i){return q.selectType.value===e.type.value&&e.active!==d.dataDefine.activeDefine["false"]},q.initTableHeader=function(){},q.onClickBoardDirection=function(e,t){if(e&&e.target&&"BUTTON"===e.target.nodeName){var i=q.boardDirectionList.indexOfItem(function(e){return e.value===t.boardDir.value&&e.displayName===t.boardDir.displayName});t.boardDir=q.boardDirectionList[(i+1)%q.boardDirectionList.length],"OUT"===t.boardDir.value?t.periodList.forEach(function(e){"BID"===e.period&&(e.period="OFR")}):"IN"===t.boardDir.value&&t.periodList.forEach(function(e){"OFR"===e.period&&(e.period="BID")})}},q.onClickQuoteType=function(t,i,n){if(t&&t.target){if("A"===t.target.nodeName){var o=e.element(t.target).scope();o&&(q.selectType=o.item)}if(q.isIBD&&"IBD"!==i.value)q.periodList=q.periodList.findWhere(function(e){return e.id&&"T7D"!==e.type&&"T14D"!==e.type||!e.id}),q.isIBD=!1;else if(q.isIBD||"IBD"!==i.value){if(q.isIBD&&"IBD"===i.value)return q.isIBD=!0,void L();if(!q.isIBD&&"IBD"!==i.value)return q.isIBD=!1,void L()}else q.periodList.splice(1,0,e.copy(d.dataDefine.periodDefine).splice(1,2)[0],e.copy(d.dataDefine.periodDefine).splice(1,2)[1]),n.forEach(function(e){"IBD"===e.type.value&&(e.periodList=e.periodList.findWhere(function(e){return e.id||!e.id&&"7天"!==e.header&&"14天"!==e.header}))}),q.isIBD=!0;L()}},q.onKeydownTable=function(i){i&&i.target&&("BUTTON"!==i.target.nodeName||i.target.className.indexOf("badge")<0||9===i.keyCode&&(i.cancelBubble=!0,u.findNextTd(i,function(i){var n=e.element(i).controller("editable");return n?(n.isEditing=!0,a(function(){$(i).addClass("is-editing"),$(i).find("input").focus()}),void n.textChanged()):void t.$emit("onTabNavigating",i)})))},q.onClickDeleteRow=function(e){if(e){var t=q.boardList.indexOfItem(function(t){return e.id?t.id===e.id:!(!t.institutionInfo||!e.institutionInfo)&&(t.seqNo===e.seqNo&&t.institutionInfo.institutionId===e.institutionInfo.institutionId)});t>=0&&(q.boardList[t].id?q.boardList[t].active=d.dataDefine.activeDefine["false"]:q.boardList.splice(t,1)),L()}},q.onClickUploadExcel=function(t){if(t&&!(t.length<=0)){var i=t[0];if(!i.name.endWith(".xls")&&!i.name.endWith(".xlsx"))return void s.message("请选择Excel文件（*.xls 或 *.xlsx）");var n=new FileReader;n.onload=function(t){var a={data:n.result,fileName:i.name};o.post(c.post_uploadExcel,a).then(function(t){if(t&&t.data.result&&t.data.result.length>0){if(t.data.result[0].error&&t.data.result[0].error.length>0){var i="导入发生错误。在Excel中</br>",n="",o=void 0;t.data.result[0].error.findWhere(function(e){return"DATA_MISSING"===e.validationErrorType}).forEach(function(e,t){n+="{0}, ".format(e.sourceField),o=e.detailMsg}),""!==n&&(n=n.substring(0,n.lastIndexOf(", ")),i+="<div>第 {0} 处, {1}。</br></div>".format(n,o)),n="",t.data.result[0].error.findWhere(function(e){return"DATA_MISSING"!==e.validationErrorType}).forEach(function(e,t){n+="{0}, ".format(e.sourceField),o=e.detailMsg}),""!==n&&(n=n.substring(0,n.lastIndexOf(", ")),i+="<div>第 {0} 行, {1}。</div>".format(n,o)),t.data.result[0].error.findWhere(function(e){return"DATA_MISSING"===e.validationErrorType}).length>0&&(i+="</br>注： {4,3} 代表第4行第3列。</br>"),s.messageHtml(void 0,i)}return q.periodList=e.copy(d.dataDefine.periodDefine),q.boardList=[],T=!0,void g(t.data.result[0].fileContent)}s.message("导入发生错误， 请修改一下再试试吧！")},function(e){if(e&&e.status===-1)return e.data&&e.data.return_message?void s.message("导入Excel错误："+e.data.return_message):void s.message("导入Excel错误。")})},n.readAsDataURL(i),L()}},q.cancel=function(){n.dismiss()},q.onClickSaveQuote=function(){if(q.isLocked=!0,!q.boardList||q.boardList.length<=0)return void n.close();var e=q.boardList.findWhere(function(e){return e.id||e.active!==d.dataDefine.activeDefine["false"]}).map(function(e){var t=r.getDto(e,C.dto.saveQuote);return t.source="QB",t.quoteDetailsDtos=e.periodList.map(function(i){isNaN(i.period)?"OFR"===i.period&&"OUT"===t.direction?i.period=null:"BID"===i.period&&"IN"===t.direction&&(i.period=null):i.period=parseFloat(i.period);var n=void 0;return i.id?n=r.getDto(i,C.dto.saveQuoteQuoteDetailsVO):(i.isRange||(i.daysHighValue=i.daysLowValue),n=r.getDto(i,C.dto.saveQuoteSpQuoteDetailsVO)),e.active===d.dataDefine.activeDefine["false"]&&(n.active=e.active),n}).findWhere(function(e){return!isNaN(e.price)||null===e.price}),t.tags=e.tags.findWhere(function(e){return e.selected===!0}).map(function(e){return{tagCode:e.tagCode}}),t.quoteUserId=e.institutionContactsId,t});e=e.findWhere(function(e){return e.id||0!==e.quoteDetailsDtos.length}),e instanceof Array&&0===e.length?q.cancel():q.isAllianceBoardable()?I(e):D(e)},t.$on("onTabNavigating",function(e,t){!t||t.length<=0}),q.onClickAddPeriod=function(){var t=i.open({animation:!1,templateUrl:"app/commons/service/offer-management/allianceAddSpPeriod.html",size:"350px",backdrop:"static",controller:"allianceAddSpPeriodController",bindToController:!0,resolve:{load:["$ocLazyLoad",function(e){return e.load([])}]}});t.result.then(function(t){if(t&&!(q.periodList.indexOfItem(function(e){return d.isSameSpPeriod(e,t)})>=0)){var i=e.copy(t);d.setSpPeriodHeader(i),q.periodList.push(i),q.periodList.sort(y),q.boardList.forEach(function(t,n){t.periodList.push(e.copy(i)),t.periodList.sort(y)}),L()}},function(e){})},q.onClickDeletePeriod=function(e){q.periodList=q.periodList.findWhere(function(t){return!!t.id||t.daysLowValue!==e.daysLowValue}),q.boardList.forEach(function(t){t.periodList=t.periodList.findWhere(function(t){return!!t.id||t.daysLowValue!==e.daysLowValue})}),L()},q.isAllianceBoardable=function(){return!(!l||!l.quoteMethod)&&(l.quoteMethod[0]===C.quoteMethodDefine[1].value||l.quoteMethod[0]===C.quoteMethodDefine[2].value)},q.onClickAddQuote=function(){return q.isAllianceBoardable()?N:b}(),q.selectTags=function(e,t){t.tagsNumber=t.tags.findWhere(function(e){return e.selected===!0}).length},q.onClickTestButton=function(e){};(function(){if(q.periodList=e.copy(d.dataDefine.periodDefine),q.boardDirectionList=d.dataDefine.boardDirection,q.typeList=C.typeListDefine,l&&l.quoteMethod){var t=C.quoteMethodDefine.findItem(function(e){return e.value===l.quoteMethod[0]});q.quoteMethod=t?t:C.quoteMethodDefine[0]}else q.quoteMethod=C.quoteMethodDefine[0];q.selectType=q.typeList[0],q.boardList=[],p&&p.result&&p.result[0]&&p.result[0].offer_data&&p.result[0].offer_data.length>0&&g(p.result[0].offer_data),L(),T=!1})()}]),e.module("services").controller("allianceAddSpPeriodController",["$scope","$uibModalInstance","$http","appConfig",function(e,t,i,n){function o(e,t){if(!t)return e;switch(t){case"d":return e;case"M":return 30*e;case"y":return 30*e*12;default:return e}}var a={rangeFlagEnum:[{displayName:"非区间期限",value:!1},{displayName:"区间期限",value:!0}],daysUnitEnum:[{displayName:"日",value:"d"},{displayName:"月",value:"M"},{displayName:"年",value:"y"}]};e.onClickCancel=function(){t.dismiss()},e.onClickOk=function(){var i=!0;e.vm.daysLow||(e.vaildDaysLow=!0,i=!1),!e.vm.daysHigh&&e.vm.isRange&&(e.vaildDaysHigh=!0,i=!1),o(+e.vm.daysHigh,e.vm.daysHighUnit)<=o(+e.vm.daysLow,e.vm.daysLowUnit)&&(e.vaildDaysLow=!0,e.vaildDaysHigh=!0,i=!1),0===+e.vm.daysLow&&(e.vaildDaysLow=!0,i=!1),i&&(e.vm.daysLow=+e.vm.daysLow,t.close(e.vm))},e.onChangeRange=function(){e.vm.daysLow=void 0,e.vm.daysHigh=void 0,e.vaildDaysLow=!1,e.vaildDaysHigh=!1},e.onClickDaysUnit=function(){};(function(){e.rangeFlagEnum=a.rangeFlagEnum,e.daysUnitEnum=a.daysUnitEnum,e.vm={daysLowUnit:void 0,daysHighUnit:void 0},e.vm.daysHighUnit=a.daysUnitEnum[0].value,e.vm.daysLowUnit=a.daysUnitEnum[0].value,e.vm.__defineGetter__("daysHighValue",function(){return o(this.daysHigh,this.daysHighUnit)}),e.vm.__defineGetter__("daysLowValue",function(){return o(this.daysLow,this.daysLowUnit)}),e.vm.isRange=!1})()}]),e.module("services").controller("allianceAddQuoteController",["$scope","$uibModalInstance","$http","appConfig","getAlliance","getBrotherAlliance","addedBoard","$uibModal","bootbox",function(e,t,i,n,o,a,r,s,d){e.selectedCount=0,e.isLocked=!1,e.onClickAlliance=function(){return e.vm&&e.vm.allianceList?void(e.selectedCount=e.vm.allianceList.findWhere(function(e){return e.isSelected}).length):void(e.selectedCount=0)},e.cancel=function(){e.vm.allianceList&&e.vm.allianceList.length>0&&e.vm.allianceList.forEach(function(e,t){delete e.isSelected,r.findItem(function(t){return t.institutionId===e.institutionId&&t.institutionContactsId&&t.institutionContactsId===e.institutionContactsId&&t.institutionContactsName&&t.institutionContactsName===e.institutionContactsName})&&(e.isQuoted=!0)}),t.dismiss()},e.addQuote=function(){e.isLocked=!0;var i=e.vm.allianceList.findWhere(function(e){return e.isSelected}),n=e.vm.allianceList.findWhere(function(e){return e.isSelected&&e.institutionContactsId&&e.institutionContactsName});i.length===n.length?t.close(n):i.length>n.length&&(d.message("请选择联系人",void 0,"smbootbox"),e.isLocked=!1)};(function(){e.vm={},o&&o.result&&o.result.length>0&&(e.vm.allianceList=o.result[0].alliance,e.vm.allianceList.forEach(function(t,i){delete t.isSelected,r&&r.length>0&&e.vm.allianceList.length>0&&r.findItem(function(e){return e.institutionId===t.institutionId&&e.institutionContactsId&&e.institutionContactsId===t.institutionContactsId&&e.institutionContactsName&&e.institutionContactsName===t.institutionContactsName})?t.isQuoted=!0:delete t.isQuoted})),a&&a.result&&a.result.length>0&&(e.vm.brotherAllianceList=a.result[0])})();e.vm.searchFilter=function(t,i,n){if(!e.vm.search)return!0;var o=t.contactsDisplayNamePinYin.indexOf(e.vm.search)===-1&&t.contactsDisplayNamePY.indexOf(e.vm.search)===-1&&t.institutionContactsName.indexOf(e.vm.search)===-1&&t.displayName.indexOf(e.vm.search)===-1&&t.pinyin.indexOf(e.vm.search)===-1&&t.pinyinFull.indexOf(e.vm.search)===-1;return!o},e.selectContact=function(e){var t=s.open({animation:!1,templateUrl:"app/commons/service/offer-management/allianceAddContact.html",size:"sm",backdrop:"static",controller:"allianceAddContactController",bindToController:!0,resolve:{load:["$ocLazyLoad",function(e){return e.load([])}],contactQuery:[function(){return e.userList}],contact:[function(){return e.institutionContactsName}]}});t.result.then(function(t){e.institutionContactsName=t.displayName,e.institutionContactsId=t.userId},function(e){})}}]),e.module("services").controller("allianceAddContactController",["$scope","$uibModalInstance","$http","appConfig","contactQuery","contact","$uibModal",function(e,t,i,n,o,a,r){a?e.contactName=a:e.contactName="请选择",e.select=function(t){e.contactName=t.displayName,e.selectContact=t},e.initView=function(){o&&o.length>0&&(e.contactsList=o)}(),e.addContact=function(){var i=e.selectContact;t.close(i)},e.cancel=function(){t.dismiss()},e.bubble=function(e){e.stopPropagation(),e.preventDefault()}}])}(angular);