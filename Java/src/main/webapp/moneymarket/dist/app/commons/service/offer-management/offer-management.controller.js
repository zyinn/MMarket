!function(e){"use strict";function t(t,i,n,r,a,o,d,s,c,u,f){function p(e){e||(e=7);var t=new Date,i=new Date;return t.setTime(i.getTime()+24*(e-1)*3600*1e3),t.setHours(23),t.setMinutes(0),t.setSeconds(0),t.format("yyyy-MM-dd HH:mm:ss")}function l(t){return{type:e.copy(t),periodList:[],featureList:e.copy(D.featureList),tagName:[],spaceList:e.copy(D.periodList),remark:void 0,active:o.dataDefine.activeDefine["true"],expiredDate:7,expiredDateString:p(7),boardDir:D.boardDirectionList.findItem(function(e){return e.value===t.direction})}}function y(){D.selectedTypeList&&(D.selectedTypeList.forEach(function(e,t){e.periodList&&e.periodList.forEach(function(e,t){e.tabIndex=2*t})}),a.safeApply(i))}function m(t){v=t,t.forEach(function(t,n){var r={id:t.id,seqNo:t.sequence,type:D.typeList.findItem(function(e){return e["enum"]===t.quoteType}),active:o.dataDefine.activeDefine["true"],remark:t.memo,expiredDate:t.valideDays?t.valideDays:7};r.expiredDateString=p(r.expiredDate),r.boardDir=D.boardDirectionList.findItem(function(e){return e.value===t.direction});var d=e.copy(D.periodList),s=e.copy(D.featureList);r.periodList=[],r.spaceList=[],r.featureList=[],r.tagName=[],t.tags&&s.forEach(function(e){t.tags.forEach(function(t){e.tagCode===t.tagCode&&(e.selected=!0)})}),s&&(r.featureList=s,r.tagName=r.featureList.findWhere(function(e){return e.selected===!0}).sort(function(e,t){return e.displayOrder-t.displayOrder}));for(var c in d)if("function"!=typeof d[c]){var u=!1,f=t.quoteDetailsDtos;for(var l in f)"function"!=typeof f[l]&&d[c]["enum"]==f[l].limitType&&(u=!0,d[c].value=f[l].price,f[l].quantity&&(d[c].amount=f[l].quantity,r.showAmount=!0),d[c].id=f[l].id,r.periodList.push(d[c]));u||r.spaceList.push(d[c])}"IBD"!==r.type["enum"]&&(r.spaceList=r.spaceList.findWhere(function(e){return"T7D"!==e["enum"]&&"T14D"!==e["enum"]})),D.selectedTypeList.push(r),a.safeApply(i)})}function L(e){return n.post("quote/save",{offer_data:e})}var D=this;D.typeList=[{name:"同存","enum":"IBD",direction:"IN"},{name:"保本","enum":"GTF",direction:"OUT"},{name:"非保本R2","enum":"UR2",direction:"OUT"},{name:"非保本R3","enum":"UR3",direction:"OUT"}],D.periodList=[{displayOrder:1,period:"1D","enum":"T1D"},{displayOrder:2,period:"7D","enum":"T7D"},{displayOrder:3,period:"14D","enum":"T14D"},{displayOrder:4,period:"1M","enum":"T1M"},{displayOrder:5,period:"2M","enum":"T2M"},{displayOrder:6,period:"3M","enum":"T3M"},{displayOrder:7,period:"6M","enum":"T6M"},{displayOrder:8,period:"9M","enum":"T9M"},{displayOrder:9,period:"1Y","enum":"T1Y"}],D.lockedPeriodList=e.copy(D.periodList),D.featureList=o.featureList.slice(1),D.selectedTypeList=[],D.boardDirectionList=o.dataDefine.boardDirection;var v;D.onKeydownTable=function(t){t&&t.target&&("BUTTON"!==t.target.nodeName||t.target.className.indexOf("badge")<0||9===t.keyCode&&(t.cancelBubble=!0,d.findNextTd(t,function(t){var n=e.element(t).controller("editable");return n?(n.isEditing=!0,r(function(){$(t).addClass("is-editing"),$(t).find("input").focus()}),void n.textChanged()):void i.$emit("onTabNavigating",t)})))},D.onClickBoardDirection=function(e,t){if(e&&e.target&&"BUTTON"===e.target.nodeName){var i=D.boardDirectionList.indexOfItem(function(t){return t.displayName===e.target.innerHTML});t.boardDir=D.boardDirectionList[i]}},D.onClickQuoteType=function(t,i){if(t&&t.target){if("A"===t.target.nodeName){var n=e.element(t.target).scope();n&&(D.selectType=n.item)}"IBD"!==i["enum"]?(D.periodList=e.copy(D.lockedPeriodList),D.periodList.splice(1,2)):D.periodList=e.copy(D.lockedPeriodList)}},D.boardListFilter=function(e,t,i){return D.selectType["enum"]===e.type["enum"]&&e.active!==o.dataDefine.activeDefine["false"]},D.periodFilter=function(e,t,i){return e.active!==o.dataDefine.activeDefine["false"]},D.deleteType=function(e){e.id?(e.active=o.dataDefine.activeDefine["false"],e.periodList.forEach(function(e){e.active=o.dataDefine.activeDefine["false"]})):D.selectedTypeList=D.selectedTypeList.findWhere(function(t){return t.$$hashKey!==e.$$hashKey}),y()},D.deletePeriod=function(e,t){t.active=o.dataDefine.activeDefine["false"],t.value=null,t.amount=null,e.spaceList.push(t),e.spaceList.sort(function(e,t){return e.displayOrder-t.displayOrder}),y()},D.addPeriod=function(e,t){var i=e.spaceList.findIndex(function(e){return e["enum"]===t["enum"]});e.spaceList.splice(i,1);var n=e.periodList.findItem(function(e){return e["enum"]===t["enum"]});n?n.active=o.dataDefine.activeDefine["true"]:e.periodList.push(t),e.periodList.sort(function(e,t){return e.displayOrder-t.displayOrder}),y()},D.onClickAddQuote=function(){var e=l(D.selectType),t=0;D.selectedTypeList.forEach(function(e,i){e.seqNo>t&&(t=e.seqNo)}),e.seqNo=t+1,D.selectedTypeList.push(e),y()},D.showAmount=function(e){e.showAmount=!0},D.hideAmount=function(e){e.showAmount=!1,e.periodList.forEach(function(e,t){delete e.amount})},D.onChangedExpiredDate=function(e,t){(t.expiredDate<=0||t.expiredDate>30)&&(t.expiredDate=""),t.expiredDateString=p(t.expiredDate)},D.setFeature=function(e,t){e.selected=!e.selected,t.tagName=t.featureList.findWhere(function(e){return e.selected===!0}).sort(function(e,t){return e.displayOrder-t.displayOrder})},D.save=function(){D.selectedTypeList.forEach(function(e,t){e.periodList=e.periodList.findWhere(function(e){return e.active!==o.dataDefine.activeDefine["false"]})}),D.selectedTypeList=D.selectedTypeList.findWhere(function(e){return e.id||0!==e.periodList.length}),c.confirm(D.selectedTypeList.findWhere(function(e){return e.active!==o.dataDefine.activeDefine["false"]}),function(){for(var e=D.selectedTypeList.map(function(e){var t=[];return e.featureList.findWhere(function(e){return e.selected===!0}).map(function(e){return e.tagCode}).forEach(function(e){var i=new Object;i.tagCode=e,t.push(i)}),{id:e.id,quoteType:e.type["enum"],direction:e.boardDir.value,memo:e.remark,tags:t,quoteDetailsDtos:e.periodList.map(function(t){var i={id:t.id,limitType:t["enum"],price:parseFloat(t.value),quantity:t.amount,active:e.active};return t.active===o.dataDefine.activeDefine["false"]&&(i.active=t.active),i}),sequence:e.seqNo,source:"QB",valideDays:e.expiredDate}}),i=0;i<v.length;i++){for(var n=!1,r=0;r<e.length;r++)if(v[i].quoteType==e[r].quoteType){n=!0;break}n||(delete v[i].quoteUserId,v[i].quoteDetailsDtos=[],e.push(v[i]))}e instanceof Array&&0===e.length?D.cancel():L(e).success(function(i){t.close(e)})})},D.cancel=function(){t.dismiss()};(function(){if(u.result&&u.result.length>0){var t=u.result[0].offer_data;0===t.length&&D.typeList.forEach(function(t){D.selectType=t,"IBD"!==D.selectType["enum"]?(D.periodList=e.copy(D.lockedPeriodList),D.periodList.splice(1,2)):D.periodList=e.copy(D.lockedPeriodList),D.onClickAddQuote()}),m(t)}D.selectType=D.typeList[0],y()})()}e.module("services").controller("offerManageController",t),t.$inject=["$uibModalInstance","$scope","$http","$timeout","commonService","offerService","tabNavigatorService","appConfig","offerConfirm","quoteQuery","tableService"]}(angular);